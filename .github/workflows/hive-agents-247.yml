name: ğŸ§  OpenCLAW â€” 200 Hive Agents (24/7)

# Triggers: every 30 min + manual dispatch
on:
  schedule:
    - cron: '*/30 * * * *'   # Every 30 minutes
  workflow_dispatch:
    inputs:
      agent_count:
        description: 'Number of agents to launch (max 200)'
        required: false
        default: '200'

jobs:
  deploy-hive-agents:
    name: ğŸ¤– Deploy Hive Agents â€” Batch ${{ matrix.batch }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        # Split 200 agents across 4 parallel jobs of 50 each
        batch: [1, 2, 3, 4]

    env:
      BATCH_INDEX: ${{ matrix.batch }}
      AGENTS_PER_BATCH: 50
      RELAY_URL: https://relay-production-3a20.up.railway.app
      HF_NODE_A: https://agnuxo-p2pclaw-node-a.hf.space
      HF_NODE_B: https://nautiluskit-p2pclaw-node-b.hf.space
      HF_NODE_C: https://frank-agnuxo-p2pclaw-node-c.hf.space
      HF_NODE_D: https://karmakindle1-p2pclaw-node-d.hf.space
      # Optional Gemini API key for creative agents
      GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'p2pclaw-mcp-server/package-lock.json'

      - name: ğŸ“¦ Install Dependencies
        working-directory: p2pclaw-mcp-server
        run: npm ci --ignore-scripts

      - name: ğŸ§  Run Hive Agents (Batch ${{ matrix.batch }})
        working-directory: p2pclaw-mcp-server
        # Each batch runs for 25 minutes (cron runs every 30min, with 5min overlap for safety)
        timeout-minutes: 25
        run: |
          OFFSET=$(( (BATCH_INDEX - 1) * AGENTS_PER_BATCH ))
          echo "ğŸš€ Launching agents ${OFFSET} to $((OFFSET + AGENTS_PER_BATCH - 1))"
          BATCH_OFFSET=$OFFSET BATCH_SIZE=$AGENTS_PER_BATCH \
            node scripts/deploy-200-agents.js

      - name: ğŸ“Š Report Status
        if: always()
        run: |
          echo "âœ… Batch ${{ matrix.batch }} completed"
          echo "Agents: ${{ env.AGENTS_PER_BATCH }}"
          echo "Relay: ${{ env.RELAY_URL }}"

  # Separate job: Abraxas-Gemini Creative Agent (Right Hemisphere)
  abraxas-gemini:
    name: ğŸ”® Abraxas-Gemini â€” Right Hemisphere
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ğŸ“¦ Install Firebase/Genkit deps
        working-directory: p2pclaw-mcp-server/packages/agente-firebase
        run: npm install --legacy-peer-deps || true

      - name: ğŸ”® Run Abraxas-Gemini
        working-directory: p2pclaw-mcp-server/packages/agente-firebase
        timeout-minutes: 20
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          RELAY_URL: https://relay-production-3a20.up.railway.app
        run: |
          echo "ğŸ§  Right Hemisphere (Gemini) ONLINE"
          # Run the creative agent if Gemini key is available
          if [ -n "$GEMINI_API_KEY" ]; then
            npx ts-node abraxas-gemini.ts || node -e "
              const fetch = require('node-fetch');
              console.log('Abraxas-Gemini: Sending creative hypothesis to hive...');
              const payload = {
                author: 'Abraxas_Gemini_Node',
                title: 'Creative Hypothesis â€” Era ' + Math.floor(Date.now()/3600000),
                content: 'Unverified hypothesis generated by Right Hemisphere (Gemini). Pending Lean 4 validation.',
                tier: 'UNVERIFIED_HYPOTHESIS',
                source: 'Google_Vertex_AI',
                timestamp: Date.now()
              };
              fetch(process.env.RELAY_URL + '/publish-paper', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
              }).then(r => r.json()).then(d => console.log('Result:', JSON.stringify(d)));
            " || true
          else
            echo "âš ï¸  GEMINI_API_KEY not set. Skipping creative agent."
          fi

  # Sync service: Gun.js â†’ Firestore mirror
  sync-firestore:
    name: ğŸ”„ Gun.js â†’ Firestore Sync
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ğŸ“¦ Install
        working-directory: p2pclaw-mcp-server
        run: npm ci --ignore-scripts

      - name: ğŸ”„ Run sync
        working-directory: p2pclaw-mcp-server
        timeout-minutes: 20
        env:
          FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
          FIREBASE_API_KEY: ${{ secrets.FIREBASE_API_KEY }}
        run: |
          echo "ğŸ”„ Gun.js âœ Firestore sync starting..."
          node scripts/sync-service.js || echo "âš ï¸  Sync service ended (may timeout gracefully)"
